<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Deveam Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    :root {
        --bg: #0e0f12;
        --card: #111215;
        --border: #1d1f23;
        --input-bg: #17181c;
        --input-border: #26282d;
        --text-gray: #9b9ca0;
        --blue: #4ea1ff;
        --yellow: #f7c843;
        --green: #63d96e;
        --red: #ff4d4d;
    }

    body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: #fff;
        font-family: "Inter", sans-serif;
        display: flex;
        justify-content: center;
    }

    .wrap {
        width: 100%;
        max-width: 420px;
        padding: 20px 16px 40px;
    }

    .title {
        font-size: 24px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
        color: #4ea1ff;
    }

    /* ======= Fragment input style ======= */
    .input-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 14px;
    }

    textarea {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        padding: 10px;
        height: 80px;
        resize: none;
        color: #fff;
        font-size: 15px;
        outline: none;
    }

    textarea::placeholder {
        color: var(--text-gray);
    }

    textarea:focus {
        border-color: #4ea1ff !important;
        outline: none !important;
        box-shadow: none !important;
    }

    /* button Fragment style */
    .btn {
        width: 100%;
        background: #1a73e8;
        border: 1px solid #1c6dd0;
        padding: 14px;
        border-radius: 12px;
        text-align: center;
        font-weight: 600;
        font-size: 16px;
        color: white;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .btn:active {
        opacity: 0.8;
    }

    /* ======= TICKET CARD ======= */
    .ticket {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 12px;
    }

    .ticket-id {
        font-size: 14px;
        opacity: 0.6;
        margin-bottom: 8px;
    }

    .ticket-text {
        font-size: 15px;
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .status {
        font-size: 14px;
        font-weight: 600;
    }

    .open { color: var(--blue); }
    .pending { color: var(--yellow); }
    .closed { color: var(--green); }

    /* ===== ADMIN PANEL ===== */
    .admin-buttons {
        margin-top: 12px;
        display: flex;
        gap: 8px;
    }

    .adm-btn {
        flex: 1;
        text-align: center;
        padding: 10px;
        border-radius: 10px;
        background: #17181c;
        border: 1px solid #26282d;
        cursor: pointer;
        font-size: 14px;
        color: #fff;
    }

    .adm-btn.blue { color: var(--blue); border-color: var(--blue); }
    .adm-btn.yellow { color: var(--yellow); border-color: var(--yellow); }
    .adm-btn.red { color: var(--red); border-color: var(--red); }

    #replyBox {
        display: none;
        margin-bottom: 20px;
    }

    #replyField {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        padding: 12px;
        border-radius: 10px;
        font-size: 15px;
        color: #fff;
        outline: none;
    }

</style>

</head>
<body>

<div class="wrap">

    <div class="title">Deveam Support</div>

    <div id="userPanel">
        <div class="input-card">
            <textarea id="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
        </div>
        <button class="btn" onclick="sendTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="replyBox">
        <input id="replyField" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é...">
        <button class="btn" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>

    <div id="tickets"></div>

</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>

let tg = window.Telegram.WebApp;
tg.expand();

let user = tg.initDataUnsafe.user;
let ADMIN = 8339987136;
let isAdmin = (user.id === ADMIN);

const API = "https://gimmicky-seamlessly-reinaldo.ngrok-free.dev"; // <<< –í–°–¢–ê–í–¨ –°–Æ–î–ê


if (isAdmin) {
    document.getElementById("replyBox").style.display = "block";
}

function sendTicket() {
    let text = document.getElementById("text").value.trim();
    if (!text) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");

    fetch(API + "/new_ticket", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            user_id: user.id,
            username: user.username || "",
            text: text
        })
    });

    document.getElementById("text").value = "";
    tg.showPopup({title: "‚úÖ –ì–æ—Ç–æ–≤–æ", message: "–í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"});
}


function loadTickets() {
    fetch(API + "/tickets?user_id=" + user.id)
    .then(r => r.json())
    .then(renderTickets);
}


function renderTickets(tickets) {
    let list = document.getElementById("tickets");
    list.innerHTML = "";

    tickets.forEach(t => {
        let card = document.createElement("div");
        card.className = "ticket";

        card.innerHTML = `
            <div class="ticket-id">#${t.id} ‚Äî @${t.username}</div>
            <div class="ticket-text">${t.text}</div>
            <div class="status ${t.status}">
                ${t.status === "open" ? "üîµ –û—Ç–∫—Ä—ã—Ç" :
                   t.status === "pending" ? "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" :
                   "‚úÖ –ó–∞–∫—Ä—ã—Ç"}
            </div>
        `;

        if (isAdmin) {
            card.onclick = () => selectedTicket = t.id;

            let btns = document.createElement("div");
            btns.className = "admin-buttons";

            btns.innerHTML = `
                <div class="adm-btn blue" onclick="setStatus(${t.id}, 'open')">–û—Ç–∫—Ä—ã—Ç</div>
                <div class="adm-btn yellow" onclick="setStatus(${t.id}, 'pending')">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ</div>
                <div class="adm-btn red" onclick="setStatus(${t.id}, 'closed')">–ó–∞–∫—Ä—ã—Ç</div>
            `;

            card.appendChild(btns);
        }

        list.appendChild(card);
    });
}


function setStatus(id, status) {
    fetch(API + "/update_status", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({id, status})
    });
}


let selectedTicket = null;

function sendReply() {
    if (!selectedTicket) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ç");

    let text = document.getElementById("replyField").value;
    if (!text.trim()) return;

    fetch(API + "/reply", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            id: selectedTicket,
            answer: text
        })
    });

    document.getElementById("replyField").value = "";
    tg.showPopup({title: "‚úÖ –£—Å–ø–µ—à–Ω–æ", message: "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"});
}


setInterval(loadTickets, 1200);
loadTickets();

</script>

</body>
</html>
