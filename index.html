<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Поддержка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100%;
    }
    html { height: 100%; }
    * { box-sizing: border-box; }

    .container { max-width: 900px; margin: 0 auto; }

    h1 { font-size: 32px; margin: 0 0 8px 0; color: #fff; }
    .subtitle { color: #888; margin-bottom: 30px; font-size: 14px; }

    .form-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }

    .form-card h2 { font-size: 18px; margin: 0 0 20px 0; color: #fff; }

    .form-row {
      display: grid;
      grid-template-columns: 200px 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .form-group { display: flex; flex-direction: column; }

    .form-group label { font-size: 13px; color: #999; margin-bottom: 6px; }

    .form-group input,
    .form-group textarea {
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #6366f1;
    }

    .form-group textarea { min-height: 44px; resize: vertical; }

    .btn {
      background: #6366f1;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover:not(:disabled) { background: #4e51dd; }

    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .btn-secondary { background: #2a2a2a; }
    .btn-secondary:hover { background: #333; }

    .tickets-section h2 { margin-bottom: 16px; }

    .ticket {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .ticket-info h3 { margin: 0; }

    .ticket-question {
      color: #ccc;
      margin-bottom: 12px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-new { background: #3b82f6; }
    .status-progress { background: #f59e0b; color: #000; }
    .status-resolved { background: #10b981; color: #000; }

    .ticket-response {
      background: #0f0f0f;
      border-left: 3px solid #6366f1;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .response-form textarea { min-height: 80px; }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
    }

    .toast.show { display: block; }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .ticket-header { flex-direction: column; }
    }
  </style>

</head>
<body>

<div class="container">

  <h1>Поддержка</h1>
  <div class="subtitle">Задайте вопрос и отслеживайте статус</div>

  <!-- FORM -->
  <div class="form-card">
    <h2>Задать вопрос</h2>
    <form id="ticket-form">
      <div class="form-row">
        <div class="form-group">
          <label>Ваше имя</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label>Вопрос</label>
          <textarea id="question" required></textarea>
        </div>

        <button class="btn" type="submit">Отправить</button>
      </div>
    </form>
  </div>

  <!-- TICKETS LIST -->
  <div class="tickets-section">
    <h2>Тикеты (<span id="ticket-count">0</span>)</h2>
    <div id="tickets-list"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API = "https://gimmicky-seamlessly-reinaldo.ngrok-free.dev";

const ADMIN = 8339987136;
const user = tg.initDataUnsafe.user;
const isAdmin = (user.id === ADMIN);

const ticketsList = document.getElementById("tickets-list");

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 3000);
}

async function loadTickets() {
  const req = await fetch(`${API}/tickets?user_id=${user.id}`);
  const data = await req.json();

  document.getElementById("ticket-count").textContent = data.length;

  ticketsList.innerHTML = "";

  data.forEach(ticket => {
    const statusClass =
      ticket.status === "resolved"
        ? "status-resolved"
        : ticket.status === "progress"
        ? "status-progress"
        : "status-new";

    const statusText =
      ticket.status === "resolved"
        ? "Решён"
        : ticket.status === "progress"
        ? "В работе"
        : "Новый";

    let html = `
      <div class="ticket">
        <div class="ticket-header">
          <div class="ticket-info">
            <h3>${ticket.name}</h3>
            <div class="ticket-meta">${new Date(ticket.timestamp).toLocaleString("ru-RU")}</div>
          </div>

          <div class="ticket-status">
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
        </div>

        <div class="ticket-question">${ticket.question}</div>
    `;

    if (ticket.response) {
      html += `
        <div class="ticket-response">
          <div class="ticket-response-label">Ответ:</div>
          <div class="ticket-response-text">${ticket.response}</div>
        </div>
      `;
    }

    if (isAdmin) {
      html += `
        <button class="btn btn-sm" onclick="setStatus('${ticket.id}', 'progress')">В работу</button>
        <button class="btn btn-sm" onclick="setStatus('${ticket.id}', 'resolved')">Решить</button>
        <button class="btn btn-sm btn-secondary" onclick="reply('${ticket.id}')">Ответить</button>
      `;
    }

    html += "</div>";
    ticketsList.innerHTML += html;
  });
}

async function reply(id) {
  const response = prompt("Введите ответ:");
  if (!response) return;

  const req = await fetch(`${API}/reply`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({id, response})
  });

  showToast("Ответ сохранён");
}

async function setStatus(id, status) {
  await fetch(`${API}/update_status`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({id, status})
  });

  showToast("Статус обновлён");
}

document.getElementById("ticket-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const question = document.getElementById("question").value.trim();

  const ticket = {
    id: Date.now().toString(),
    name,
    question,
    response: "",
    status: "new",
    timestamp: new Date().toISOString(),
    user_id: user.id
  };

  await fetch(`${API}/new_ticket`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(ticket)
  });

  showToast("Тикет создан");

  loadTickets();
});

setInterval(loadTickets, 2000);
loadTickets();
</script>

</body>
</html>
